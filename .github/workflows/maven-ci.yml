name: Maven CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ã‚¹ãƒ†ãƒ¼ã‚¸1: ã‚³ãƒ¼ãƒ‰ã®ãƒ“ãƒ«ãƒ‰ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [11, 17]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ”¨ Compile project
      run: mvn clean compile
    
    - name: ğŸ“¦ Upload compiled classes
      uses: actions/upload-artifact@v4
      with:
        name: compiled-classes-java-${{ matrix.java-version }}
        path: target/classes
        retention-days: 1

  # ã‚¹ãƒ†ãƒ¼ã‚¸2: å˜ä½“ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        java-version: [11, 17]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ“¥ Download compiled classes
      uses: actions/download-artifact@v4
      with:
        name: compiled-classes-java-${{ matrix.java-version }}
        path: target/classes
    
    - name: ğŸ§ª Run unit tests
      run: mvn test -DskipCompile
    
    - name: ğŸ“Š Generate test report
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results - Java ${{ matrix.java-version }}
        path: target/surefire-reports/*.xml
        reporter: java-junit
        fail-on-error: false
    
    - name: ğŸ“ˆ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-java-${{ matrix.java-version }}
        path: target/surefire-reports/
        retention-days: 7

  # ã‚¹ãƒ†ãƒ¼ã‚¸3: é™çš„è§£æ
  code-analysis:
    name: ğŸ” Code Analysis
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        java-version: [11, 17]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ“¥ Download compiled classes
      uses: actions/download-artifact@v4
      with:
        name: compiled-classes-java-${{ matrix.java-version }}
        path: target/classes
    
    - name: ğŸ› Run SpotBugs analysis
      run: mvn spotbugs:check
    
    - name: ğŸ“„ Generate SpotBugs report
      if: always()
      run: mvn spotbugs:spotbugs
    
    - name: ğŸ“¤ Upload SpotBugs results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: spotbugs-results-java-${{ matrix.java-version }}
        path: |
          target/spotbugsXml.xml
          target/site/spotbugs.html
        retention-days: 7

  # ã‚¹ãƒ†ãƒ¼ã‚¸4: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°
  package:
    name: ğŸ“¦ Package
    runs-on: ubuntu-latest
    needs: [test, code-analysis]
    strategy:
      matrix:
        java-version: [11, 17]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ“¦ Package application
      run: mvn package -DskipTests
    
    - name: ğŸ“¤ Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-jar-java-${{ matrix.java-version }}
        path: target/*.jar
        retention-days: 30

  # ã‚¹ãƒ†ãƒ¼ã‚¸5: ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸã‹ã®ç¢ºèª
  quality-gate:
    name: âœ… Quality Gate
    runs-on: ubuntu-latest
    needs: [test, code-analysis, package]
    
    steps:
    - name: ğŸ‰ All checks passed
      run: |
        echo "âœ… Build successful"
        echo "âœ… All tests passed"
        echo "âœ… Code analysis completed"
        echo "âœ… Package created successfully"
        echo ""
        echo "ğŸš€ Ready for deployment!"